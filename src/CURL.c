#include "CURL.h"

int GET_FILE(char *url, char *file)
{
    CURLcode ret;
    CURL *hnd;
    
    struct chunck RESPONSE;
    INIT_CHUNCK(&RESPONSE);
    
    hnd = curl_easy_init();
    if (!hnd)
    {
        fprintf(stderr,"["RED("-")"] Curl init failed\n");
        return EXIT_FAILURE;
    }

    curl_easy_setopt(hnd, CURLOPT_BUFFERSIZE, 102400L);
    curl_easy_setopt(hnd, CURLOPT_URL, URL);
    curl_easy_setopt(hnd, CURLOPT_NOPROGRESS, 1L);
    curl_easy_setopt(hnd, CURLOPT_USERAGENT, USER_AGENT);
    curl_easy_setopt(hnd, CURLOPT_MAXREDIRS, 50L);
    curl_easy_setopt(hnd, CURLOPT_HTTP_VERSION, (long)CURL_HTTP_VERSION_2TLS);
    curl_easy_setopt(hnd, CURLOPT_SSL_VERIFYPEER, 0L);
    curl_easy_setopt(hnd, CURLOPT_SSL_VERIFYHOST, 0L);
    curl_easy_setopt(hnd, CURLOPT_PATH_AS_IS, 1L);
    curl_easy_setopt(hnd, CURLOPT_CUSTOMREQUEST, "GET");
    curl_easy_setopt(hnd, CURLOPT_FTP_SKIP_PASV_IP, 1L);
    curl_easy_setopt(hnd, CURLOPT_TCP_KEEPALIVE, 1L);
    curl_easy_setopt(hnd, CURLOPT_WRITEFUNCTION, GET_RESP);
    curl_easy_setopt(hnd, CURLOPT_WRITEDATA, &RESPONSE);
    
    ret = curl_easy_perform(hnd);

    if (ret != CURLE_OK)
    {
        fprintf(stderr,"["RED("~")"] Error Occured As: "RED("%s")"\n",curl_easy_strerror(ret));
        free(URL);
        free(RESPONSE.ptr);
        exit(EXIT_FAILURE);
    }

    curl_easy_cleanup(hnd);
    CHECK_CREDS(RESPONSE.ptr);
    hnd = NULL;
    free(URL);
    free(RESPONSE.ptr);
    return (int)ret;
}